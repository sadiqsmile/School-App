rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------
    // Helpers
    // ------------------------------------------------------------------
    function signedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function tokenEmail() {
      return signedIn() ? request.auth.token.email : null;
    }

    function isParentAuthEmail() {
      // Parents sign in with: <10digits>@parents.sk-school-master
      return tokenEmail() != null && tokenEmail().matches('^[0-9]{10}@parents\\.hongirana\\.school$');
        return tokenEmail() != null && tokenEmail().matches('^[0-9]{10}@parents\\.skschoolmaster\\.school$');
    }

    function parentEmailForMobile(mobile) {
      return mobile + '@parents.sk-school-master';
    }

    function isSameParentMobile(mobile) {
      return isParentAuthEmail() && tokenEmail() == parentEmailForMobile(mobile);
    }

    function userPath(schoolId, u) {
      return /databases/$(database)/documents/schools/$(schoolId)/users/$(u);
    }

    function hasUserDoc(schoolId) {
      return signedIn() && exists(userPath(schoolId, uid()));
    }

    function me(schoolId) {
      return hasUserDoc(schoolId) ? get(userPath(schoolId, uid())).data : null;
    }

    function myRole(schoolId) {
      return hasUserDoc(schoolId) ? (me(schoolId).role) : null;
    }

    function isActiveSchoolUser(schoolId) {
      // Treat missing isActive as true (backward compatibility).
      return hasUserDoc(schoolId) && (!("isActive" in me(schoolId)) || me(schoolId).isActive == true);
    }

    function isAdmin(schoolId) {
      return isActiveSchoolUser(schoolId) && myRole(schoolId) == 'admin';
    }

    function isTeacher(schoolId) {
      return isActiveSchoolUser(schoolId) && myRole(schoolId) == 'teacher';
    }

    function isParent(schoolId) {
      return isActiveSchoolUser(schoolId) && myRole(schoolId) == 'parent';
    }

    function teacherAssignmentPath(schoolId, teacherUid) {
      return /databases/$(database)/documents/schools/$(schoolId)/teacherAssignments/$(teacherUid);
    }

    function teacherAssignmentIds(schoolId, teacherUid) {
      return exists(teacherAssignmentPath(schoolId, teacherUid))
        && ("classSectionIds" in get(teacherAssignmentPath(schoolId, teacherUid)).data)
        ? get(teacherAssignmentPath(schoolId, teacherUid)).data.classSectionIds
        : [];
    }

    function teacherAssignedClassSection(schoolId, classSectionId) {
      return isTeacher(schoolId)
        && teacherAssignmentIds(schoolId, uid()).hasAny([classSectionId]);
    }

    function teacherAssignedToClassSection(schoolId, classId, sectionId) {
      return teacherAssignedClassSection(schoolId, classId + '_' + sectionId);
    }

    function parentHasClassSection(schoolId, classId, sectionId) {
      return isParent(schoolId)
        && ("childClassSectionIds" in me(schoolId))
        && me(schoolId).childClassSectionIds.hasAny([classId + '_' + sectionId]);
    }

    function parentHasClassSectionId(schoolId, classSectionId) {
      return isParent(schoolId)
        && ("childClassSectionIds" in me(schoolId))
        && me(schoolId).childClassSectionIds.hasAny([classSectionId]);
    }

    function baseStudentPath(schoolId, studentId) {
      return /databases/$(database)/documents/schools/$(schoolId)/students/$(studentId);
    }

    function baseStudentDoc(schoolId, studentId) {
      return exists(baseStudentPath(schoolId, studentId))
        ? get(baseStudentPath(schoolId, studentId)).data
        : {};
    }

    function isParentOfStudent(schoolId, studentId) {
      // Link via parentAuthUid OR via parentMobile matching parent-auth email.
      return signedIn() && (
        ("parentAuthUid" in baseStudentDoc(schoolId, studentId) && baseStudentDoc(schoolId, studentId).parentAuthUid == uid())
        || ("parentMobile" in baseStudentDoc(schoolId, studentId) && isSameParentMobile(baseStudentDoc(schoolId, studentId).parentMobile))
      );
    }

    function yearStudentPath(schoolId, yearId, studentId) {
      return /databases/$(database)/documents/schools/$(schoolId)/academicYears/$(yearId)/students/$(studentId);
    }

    function yearStudentDoc(schoolId, yearId, studentId) {
      return exists(yearStudentPath(schoolId, yearId, studentId))
        ? get(yearStudentPath(schoolId, yearId, studentId)).data
        : {};
    }

    function teacherAssignedToYearStudent(schoolId, yearId, studentId) {
      return isTeacher(schoolId)
        && ("classSectionId" in yearStudentDoc(schoolId, yearId, studentId))
        && teacherAssignedClassSection(schoolId, yearStudentDoc(schoolId, yearId, studentId).classSectionId);
    }

    function onlyChangesKeys(allowedKeys) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedKeys);
    }

    // ------------------------------------------------------------------
    // School tree
    // ------------------------------------------------------------------
    match /schools/{schoolId} {
      // School root doc is not used directly by clients.
      allow read, write: if false;

      // ---- App settings ----
      match /settings/{docId} {
        allow read: if signedIn();
        allow write: if isAdmin(schoolId);
      }

      // ---- User profiles ----
      match /users/{userId} {
        allow read: if signedIn() && (userId == uid() || isAdmin(schoolId));

        // Self-service profile doc (created/updated on login).
        allow create, update: if signedIn() && userId == uid();
        allow delete: if isAdmin(schoolId);
      }

      // ---- Teacher assignments ----
      match /teacherAssignments/{teacherUid} {
        allow read: if isAdmin(schoolId) || (signedIn() && teacherUid == uid());
        allow write: if isAdmin(schoolId);
      }

      // ---- Static master data ----
      match /classes/{classId} {
        allow read: if isActiveSchoolUser(schoolId);
        allow write: if isAdmin(schoolId);
      }

      match /sections/{sectionId} {
        allow read: if isActiveSchoolUser(schoolId);
        allow write: if isAdmin(schoolId);
      }

      match /teachers/{teacherUid} {
        allow read: if isActiveSchoolUser(schoolId);
        allow write: if isAdmin(schoolId) || (signedIn() && teacherUid == uid());
      }

      match /parents/{mobile} {
        allow read: if isAdmin(schoolId) || isSameParentMobile(mobile);

        // Admin manages parent docs.
        allow create, delete: if isAdmin(schoolId);

        // Parent can update their own doc, but only non-sensitive fields
        // Protected fields (can only be modified by admin): 
        //   - approvalStatus (pending/approved/rejected/blocked)
        //   - mustChangePassword
        //   - isActive
        //   - firstLoginAt, lastLoginAt, approvedAt, etc.
        allow update: if isAdmin(schoolId) || (
          isSameParentMobile(mobile)
          && onlyChangesKeys([
            'failedAttempts',
            'lockUntil',
            'updatedAt'
          ])
        );
      }

      // ---- Parent Login Requests (approval workflow) ----
      match /parentLoginRequests/{mobile} {
        // Admin can read all pending login requests
        allow read: if isAdmin(schoolId);

        // Admin creates/updates login requests with approval decisions
        allow create, update: if isAdmin(schoolId);

        // Parent can check their own login request status
        allow read: if isSameParentMobile(mobile);

        // Disallow parent deletes
        allow delete: if isAdmin(schoolId);
      }

      match /students/{studentId} {
        allow read: if isAdmin(schoolId) || isTeacher(schoolId) || isParentOfStudent(schoolId, studentId);

        // Admin manages student profiles.
        allow create, delete: if isAdmin(schoolId);

        // Parent can only attach their auth uid to their own child record.
        allow update: if isAdmin(schoolId)
          || (
            signedIn()
            && ("parentMobile" in resource.data)
            && isSameParentMobile(resource.data.parentMobile)
            && onlyChangesKeys(['parentAuthUid', 'updatedAt'])
            && request.resource.data.parentAuthUid == uid()
          );
      }

      // ---- Academic Years ----
      match /academicYears/{yearId} {
        allow read: if isActiveSchoolUser(schoolId);
        allow write: if isAdmin(schoolId);

        match /classSections/{classSectionId} {
          allow read: if isActiveSchoolUser(schoolId);
          allow write: if isAdmin(schoolId);
        }

        // Year student snapshots (for teacher + parent access)
        match /students/{studentId} {
          allow read: if isAdmin(schoolId)
            || teacherAssignedToYearStudent(schoolId, yearId, studentId)
            || isParentOfStudent(schoolId, studentId);
          allow write: if isAdmin(schoolId);
        }

        // ------------------------------------------------------------------
        // Homework / Notes (with Storage attachments)
        // schools/{schoolId}/academicYears/{yearId}/homework/{homeworkId}
        // ------------------------------------------------------------------
        match /homework/{homeworkId} {
          function classId() { return (resource.data['class'] is string) ? resource.data['class'] : ''; }
          function sectionId() { return (resource.data['section'] is string) ? resource.data['section'] : ''; }
          function csId() { return classId() + '_' + sectionId(); }

          allow read: if isAdmin(schoolId)
            || (isTeacher(schoolId) && teacherAssignedClassSection(schoolId, csId()))
            || (
              isParent(schoolId)
              && resource.data.isActive == true
              && parentHasClassSectionId(schoolId, csId())
            );

          allow create: if isAdmin(schoolId)
            || (
              isTeacher(schoolId)
              && teacherAssignedToClassSection(
                schoolId,
                request.resource.data['class'],
                request.resource.data['section']
              )
              && request.resource.data.createdByUid == uid()
            );

          allow update: if isAdmin(schoolId)
            || (
              isTeacher(schoolId)
              && resource.data.createdByUid == uid()
              && teacherAssignedToClassSection(schoolId, resource.data['class'], resource.data['section'])
            );

          allow delete: if isAdmin(schoolId)
            || (
              isTeacher(schoolId)
              && resource.data.createdByUid == uid()
              && teacherAssignedToClassSection(schoolId, resource.data['class'], resource.data['section'])
            );
        }

        // ------------------------------------------------------------------
        // Attendance v3 (privacy safe)
        // attendanceStudents/{studentId}/days/{yyyy-MM-dd}
        // attendanceSummaries/{classSectionId}/days/{yyyy-MM-dd}
        // ------------------------------------------------------------------
        match /attendanceStudents/{studentId}/days/{dateId} {
          allow read: if isAdmin(schoolId)
            || teacherAssignedToClassSection(schoolId, resource.data['class'], resource.data['section'])
            || isParentOfStudent(schoolId, studentId);

          allow create, update: if isTeacher(schoolId)
            && teacherAssignedToClassSection(schoolId, request.resource.data['class'], request.resource.data['section'])
            && request.resource.data.studentId == studentId
            && request.resource.data.markedByUid == uid()
            && request.resource.data.status in ['P', 'A'];
        }

        match /attendanceSummaries/{classSectionId}/days/{dateId} {
          allow read: if isAdmin(schoolId)
            || teacherAssignedClassSection(schoolId, classSectionId)
            || parentHasClassSectionId(schoolId, classSectionId);

          allow create, update: if isTeacher(schoolId)
            && teacherAssignedClassSection(schoolId, classSectionId)
            && request.resource.data.markedByUid == uid();
        }

        // Legacy attendance (blocked for parents by default).
        match /attendance/{classId}/{rest=**} {
          allow read, write: if isAdmin(schoolId) || isTeacher(schoolId);
        }
      }

      // ------------------------------------------------------------------
      // NEW Attendance System v4 (with time restrictions & locking)
      // schools/{schoolId}/attendance/{classSectionId}/days/{date}
      // ------------------------------------------------------------------
      match /attendance/{classSectionId}/days/{dateId} {
        function isTeachingStaff(schoolId) {
          return myRole(schoolId) in ["teacher", "class_teacher", "admin"];
        }

        function beforeDeadline() {
          return request.time.hour < 16; // Before 4:00 PM
        }

        // Read: authenticated users can view
        allow read: if signedIn();

        // Create: only teachers/admins can create
        allow create: if signedIn()
          && isTeachingStaff(schoolId);

        // Update: teachers before 4 PM, admins anytime
        allow update: if signedIn()
          && (
            myRole(schoolId) == "admin" ||
            (isTeachingStaff(schoolId) && beforeDeadline())
          );

        // Delete: admin only
        allow delete: if isAdmin(schoolId);
      }

      // ------------------------------------------------------------------
      // Attendance Summaries (auto-generated by Cloud Functions)
      // schools/{schoolId}/attendance_summary/{classSectionId}/months/{monthDate}
      // ------------------------------------------------------------------
      match /attendance_summary/{classSectionId}/months/{monthDate} {
        allow read: if signedIn();
        allow write: if false; // Cloud Functions only
      }

      // ------------------------------------------------------------------
      // Notification Audit Log
      // schools/{schoolId}/notifications_log/{logId}
      // ------------------------------------------------------------------
      match /notifications_log/{logId} {
        allow read: if signedIn()
          && (isAdmin(schoolId) || isTeacher(schoolId));

        allow write: if false; // Cloud Functions only

        // ------------------------------------------------------------------
        // Notifications
        // ------------------------------------------------------------------
        match /notifications/{notificationId} {
          allow read: if isActiveSchoolUser(schoolId);
          allow create: if isAdmin(schoolId) || isTeacher(schoolId);
          allow update, delete: if isAdmin(schoolId)
            || (isTeacher(schoolId) && resource.data.createdByUid == uid());
        }

        // ------------------------------------------------------------------
        // Timetables
        // schools/{schoolId}/academicYears/{yearId}/timetables/{groupId}/{classId}/{sectionId}
        // ------------------------------------------------------------------
        match /timetables/{groupId}/{classId}/{sectionId} {
          allow read: if isAdmin(schoolId)
            || (isTeacher(schoolId) && teacherAssignedToClassSection(schoolId, classId, sectionId))
            || (isParent(schoolId) && parentHasClassSection(schoolId, classId, sectionId));

          allow write: if isAdmin(schoolId)
            || (isTeacher(schoolId) && teacherAssignedToClassSection(schoolId, classId, sectionId));
        }

        // ------------------------------------------------------------------
        // Exams v1
        // ------------------------------------------------------------------
        match /exams/{examId} {
          allow read: if isActiveSchoolUser(schoolId);
          allow create, update, delete: if isAdmin(schoolId) || isTeacher(schoolId);

          match /timetable/{classSectionId} {
            allow read: if isAdmin(schoolId)
              || (isTeacher(schoolId) && teacherAssignedClassSection(schoolId, classSectionId))
              || (isParent(schoolId) && parentHasClassSectionId(schoolId, classSectionId));

            allow write: if isAdmin(schoolId)
              || (isTeacher(schoolId) && teacherAssignedClassSection(schoolId, classSectionId));
          }

          match /results/{studentId} {
            allow read: if isAdmin(schoolId)
              || (isTeacher(schoolId) && teacherAssignedToClassSection(schoolId, resource.data['class'], resource.data['section']))
              || (isParent(schoolId) && isParentOfStudent(schoolId, studentId) && resource.data.isPublished == true);

            // Teachers can create/update results for their assigned class-section
            // Only allowed to set entered fields, not approval/publish fields
            allow create, update: if (isTeacher(schoolId)
              && teacherAssignedToClassSection(schoolId, request.resource.data['class'], request.resource.data['section'])
              && request.resource.data.enteredByUid == uid()
              // Teacher can only modify: enteredByUid, enteredAt, subjects, total, percentage, grade, updatedAt
              && (!('isApproved' in request.resource.data) || request.resource.data.isApproved == (resource == null ? false : resource.data.isApproved))
              && (!('approvedByUid' in request.resource.data) || request.resource.data.approvedByUid == (resource == null ? null : resource.data.approvedByUid))
              && (!('approvedAt' in request.resource.data) || request.resource.data.approvedAt == (resource == null ? null : resource.data.approvedAt))
              && (!('isPublished' in request.resource.data) || request.resource.data.isPublished == (resource == null ? false : resource.data.isPublished))
              && (!('publishedByUid' in request.resource.data) || request.resource.data.publishedByUid == (resource == null ? null : resource.data.publishedByUid))
              && (!('publishedAt' in request.resource.data) || request.resource.data.publishedAt == (resource == null ? null : resource.data.publishedAt))
            )
            // Admin can create/update and set approval/publish fields
            || (isAdmin(schoolId));

            allow delete: if isAdmin(schoolId);
          }
        }

        // ------------------------------------------------------------------
        // Exam Marks Results (new system)
        // schools/{schoolId}/academicYears/{yearId}/exams/{examId}/marksResults/{studentId}
        // ------------------------------------------------------------------
        match /exams/{examId}/marksResults/{studentId} {
          function canReadMarksResult() {
            return isAdmin(schoolId)
              || (isTeacher(schoolId) && teacherAssignedToClassSection(schoolId, resource.data['classId'], resource.data['sectionId']))
              || (isParent(schoolId) && isParentOfStudent(schoolId, studentId));
          }

          function canWriteMarksResult() {
            return isAdmin(schoolId)
              || (isTeacher(schoolId) && teacherAssignedToClassSection(schoolId, request.resource.data['classId'], request.resource.data['sectionId']));
          }

          allow read: if canReadMarksResult();

          // Admin can create/update all marks
          allow create, update: if isAdmin(schoolId);

          // Teacher can only update their subject marks
          // They cannot modify other subjects or metadata
          allow update: if isTeacher(schoolId)
            && teacherAssignedToClassSection(schoolId, resource.data['classId'], resource.data['sectionId'])
            && request.resource.data.studentId == resource.data.studentId
            && request.resource.data.updatedByUid == uid()
            // Preserve non-subject data
            && request.resource.data.examId == resource.data.examId
            && request.resource.data.examName == resource.data.examName
            && request.resource.data.name == resource.data.name
            && request.resource.data.classId == resource.data.classId
            && request.resource.data.sectionId == resource.data.sectionId
            && request.resource.data.groupId == resource.data.groupId
            && request.resource.data.admissionNo == resource.data.admissionNo;

          allow delete: if isAdmin(schoolId);
        }
      }
    }

    // Deny by default.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
